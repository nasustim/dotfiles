name: Test

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  test:
    timeout-minutes: 30
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3.5.3
      
      - name: Install yq on Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
      - name: Test link and unlink functionality
        run: |
          # First run our comprehensive test script
          ./test_link_unlink.sh
          
          # Then test the actual workflow
          # Test linking
          make
          
          # Count created symlinks
          LINK_COUNT=$(find ~ -maxdepth 3 -type l | wc -l | tr -d ' ')
          echo "Created $LINK_COUNT symbolic links"
          
          # Test unlinking
          make clean
          
          # Verify all symlinks were removed
          REMAINING_LINKS=$(find ~ -maxdepth 3 -type l | wc -l | tr -d ' ')
          echo "Remaining symbolic links: $REMAINING_LINKS"
          
          if [ "$REMAINING_LINKS" -gt 0 ]; then
            echo "Error: Some symbolic links were not removed"
            find ~ -maxdepth 3 -type l
            exit 1
          fi
          
          echo "All tests passed successfully"
